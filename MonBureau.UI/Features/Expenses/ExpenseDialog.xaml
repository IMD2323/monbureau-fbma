<!--
    ============================================================================
    ExpenseDialog.xaml - FIXED: Resizable with proper constraints
    ============================================================================
-->
<Window
    x:Class="MonBureau.UI.Views.Dialogs.ExpenseDialog"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:enums="clr-namespace:MonBureau.Core.Enums;assembly=MonBureau.Core"
    Title="Dépense"
    Width="750"
    Height="800"
    MinWidth="650"
    MinHeight="600"
    MaxWidth="1200"
    MaxHeight="1000"
    Background="{StaticResource BackgroundBrush}"
    ResizeMode="CanResize"
    SizeToContent="Manual"
    WindowStartupLocation="CenterOwner">

    <Border Padding="32">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!--  Header  -->
            <StackPanel Grid.Row="0" Margin="0,0,0,24">
                <TextBlock FontSize="24" FontWeight="Bold">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Text" Value="Nouvelle Dépense" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                    <Setter Property="Text" Value="Modifier Dépense" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
                <TextBlock
                    Margin="0,4,0,0"
                    FontSize="14"
                    Foreground="{StaticResource TextSecondaryBrush}"
                    Text="Enregistrer une dépense liée à un dossier" />
            </StackPanel>

            <!--  Form  -->
            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <!--  Description  -->
                    <StackPanel Margin="0,0,0,20">
                        <TextBlock
                            Margin="0,0,0,8"
                            FontSize="13"
                            FontWeight="Medium"
                            Text="Description *" />
                        <TextBox
                            Style="{StaticResource ModernTextBox}"
                            Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}"
                            TextWrapping="Wrap" />
                    </StackPanel>

                    <!--  Amount & Date - FIXED: Use AmountText property  -->
                    <Grid Margin="0,0,0,20">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="16" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock
                                Margin="0,0,0,8"
                                FontSize="13"
                                FontWeight="Medium"
                                Text="Montant (DA) *" />
                            <!--  FIXED: Bind to AmountText instead of Amount  -->
                            <TextBox Style="{StaticResource ModernTextBox}" Text="{Binding AmountText, UpdateSourceTrigger=PropertyChanged}" />
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <TextBlock
                                Margin="0,0,0,8"
                                FontSize="13"
                                FontWeight="Medium"
                                Text="Date *" />
                            <DatePicker SelectedDate="{Binding Date}" Style="{StaticResource ModernDatePicker}" />
                        </StackPanel>
                    </Grid>

                    <!--  Category & Payment Method - FIXED: Proper ComboBox bindings  -->
                    <Grid Margin="0,0,0,20">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="16" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock
                                Margin="0,0,0,8"
                                FontSize="13"
                                FontWeight="Medium"
                                Text="Catégorie *" />
                            <!--  FIXED: Use proper enum binding  -->
                            <ComboBox
                                ItemsSource="{Binding ExpenseCategories}"
                                SelectedItem="{Binding SelectedCategory}"
                                Style="{StaticResource ModernComboBox}">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding}" />
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <TextBlock
                                Margin="0,0,0,8"
                                FontSize="13"
                                FontWeight="Medium"
                                Text="Mode de Paiement" />
                            <!--  FIXED: Use SelectedValue with proper string values  -->
                            <ComboBox
                                IsEditable="True"
                                SelectedValue="{Binding PaymentMethod, UpdateSourceTrigger=PropertyChanged}"
                                SelectedValuePath="Content"
                                Style="{StaticResource ModernComboBox}">
                                <ComboBoxItem Content="Espèces" />
                                <ComboBoxItem Content="Chèque" />
                                <ComboBoxItem Content="Virement" />
                                <ComboBoxItem Content="Carte Bancaire" />
                            </ComboBox>
                        </StackPanel>
                    </Grid>

                    <!--  Recipient  -->
                    <StackPanel Margin="0,0,0,20">
                        <TextBlock
                            Margin="0,0,0,8"
                            FontSize="13"
                            FontWeight="Medium"
                            Text="Bénéficiaire" />
                        <TextBox Style="{StaticResource ModernTextBox}" Text="{Binding Recipient, UpdateSourceTrigger=PropertyChanged}" />
                    </StackPanel>

                    <!--  Case Selection - FIXED: Show case number and client  -->
                    <StackPanel Margin="0,0,0,20">
                        <TextBlock
                            Margin="0,0,0,8"
                            FontSize="13"
                            FontWeight="Medium"
                            Text="Dossier *" />
                        <ComboBox
                            ItemsSource="{Binding Cases}"
                            SelectedItem="{Binding SelectedCase}"
                            Style="{StaticResource ModernComboBox}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <TextBlock FontWeight="SemiBold" Text="{Binding Number}" />
                                        <TextBlock
                                            FontSize="11"
                                            Foreground="#666"
                                            Text="{Binding Client.FullName, StringFormat='Client: {0}'}" />
                                    </StackPanel>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </StackPanel>

                    <!--  Client Selection - FIXED: Custom ItemTemplate  -->
                    <StackPanel Margin="0,0,0,20">
                        <TextBlock
                            Margin="0,0,0,8"
                            FontSize="13"
                            FontWeight="Medium"
                            Text="Ajouté par (Client)" />
                        <ComboBox
                            ItemsSource="{Binding Clients}"
                            SelectedItem="{Binding AddedByClient}"
                            Style="{StaticResource ModernComboBox}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock>
                                        <TextBlock.Text>
                                            <MultiBinding StringFormat="{}{0} {1}">
                                                <Binding Path="FirstName" />
                                                <Binding Path="LastName" />
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </StackPanel>

                    <!--  Notes  -->
                    <StackPanel Margin="0,0,0,20">
                        <TextBlock
                            Margin="0,0,0,8"
                            FontSize="13"
                            FontWeight="Medium"
                            Text="Notes" />
                        <TextBox
                            MinHeight="80"
                            AcceptsReturn="True"
                            Style="{StaticResource ModernTextBox}"
                            Text="{Binding Notes, UpdateSourceTrigger=PropertyChanged}"
                            TextWrapping="Wrap" />
                    </StackPanel>

                    <!--  Is Paid  -->
                    <CheckBox
                        Content="Dépense payée"
                        IsChecked="{Binding IsPaid}"
                        Style="{StaticResource ModernCheckBox}" />

                    <!--  Validation Error  -->
                    <Border
                        Margin="0,20,0,0"
                        Padding="12"
                        Background="{StaticResource ErrorSubtleBrush}"
                        BorderBrush="{StaticResource ErrorBrush}"
                        BorderThickness="1"
                        CornerRadius="6"
                        Visibility="{Binding ValidationError, Converter={StaticResource BoolToVis}}">
                        <TextBlock
                            FontSize="13"
                            Foreground="{StaticResource ErrorBrush}"
                            Text="{Binding ValidationError}"
                            TextWrapping="Wrap" />
                    </Border>
                </StackPanel>
            </ScrollViewer>

            <!--  Actions  -->
            <Grid Grid.Row="2" Margin="0,20,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Button
                    Grid.Column="1"
                    Margin="0,0,12,0"
                    Padding="24,12"
                    Command="{Binding CancelCommand}"
                    CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=Window}}"
                    Content="Annuler"
                    IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBool}}"
                    Style="{StaticResource OutlineButton}" />

                <Button
                    Grid.Column="2"
                    Padding="24,12"
                    Command="{Binding SaveCommand}"
                    CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=Window}}"
                    IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBool}}"
                    Style="{StaticResource PrimaryButton}">
                    <Button.Content>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Enregistrer" />
                            <TextBlock
                                Margin="8,0,0,0"
                                Text="⏳"
                                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}" />
                        </StackPanel>
                    </Button.Content>
                </Button>
            </Grid>
        </Grid>
    </Border>
</Window>