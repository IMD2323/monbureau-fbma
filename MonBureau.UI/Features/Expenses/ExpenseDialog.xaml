<!--  ============================================================================  -->
<!--  ExpenseDialog.xaml - FIXED  -->
<!--  ============================================================================  -->
<Window
    x:Class="MonBureau.UI.Views.Dialogs.ExpenseDialog"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    Title="Dépense"
    Width="700"
    Height="750"
    Background="{StaticResource BackgroundBrush}"
    ResizeMode="NoResize"
    WindowStartupLocation="CenterOwner">

    <Border Padding="32">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!--  Header  -->
            <StackPanel Grid.Row="0" Margin="0,0,0,24">
                <TextBlock FontSize="24" FontWeight="Bold">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Text" Value="Nouvelle Dépense" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                    <Setter Property="Text" Value="Modifier Dépense" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
                <TextBlock
                    Margin="0,4,0,0"
                    FontSize="14"
                    Foreground="{StaticResource TextSecondaryBrush}"
                    Text="Enregistrer une dépense liée à un dossier" />
            </StackPanel>

            <!--  Form  -->
            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <!--  Description  -->
                    <StackPanel Margin="0,0,0,20">
                        <TextBlock
                            Margin="0,0,0,8"
                            FontSize="13"
                            FontWeight="Medium"
                            Text="Description *" />
                        <TextBox
                            Style="{StaticResource ModernTextBox}"
                            Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}"
                            TextWrapping="Wrap" />
                    </StackPanel>

                    <!--  Amount & Date  -->
                    <Grid Margin="0,0,0,20">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="16" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock
                                Margin="0,0,0,8"
                                FontSize="13"
                                FontWeight="Medium"
                                Text="Montant (DA) *" />
                            <TextBox Style="{StaticResource ModernTextBox}" Text="{Binding Amount, UpdateSourceTrigger=PropertyChanged}" />
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <TextBlock
                                Margin="0,0,0,8"
                                FontSize="13"
                                FontWeight="Medium"
                                Text="Date *" />
                            <DatePicker SelectedDate="{Binding Date}" Style="{StaticResource ModernDatePicker}" />
                        </StackPanel>
                    </Grid>

                    <!--  Category & Payment Method  -->
                    <Grid Margin="0,0,0,20">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="16" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock
                                Margin="0,0,0,8"
                                FontSize="13"
                                FontWeight="Medium"
                                Text="Catégorie *" />
                            <ComboBox
                                ItemsSource="{Binding ExpenseCategories}"
                                SelectedItem="{Binding SelectedCategory}"
                                Style="{StaticResource ModernComboBox}" />
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <TextBlock
                                Margin="0,0,0,8"
                                FontSize="13"
                                FontWeight="Medium"
                                Text="Mode de Paiement" />
                            <ComboBox
                                IsEditable="True"
                                Style="{StaticResource ModernComboBox}"
                                Text="{Binding PaymentMethod, UpdateSourceTrigger=PropertyChanged}">
                                <ComboBoxItem Content="Espèces" />
                                <ComboBoxItem Content="Chèque" />
                                <ComboBoxItem Content="Virement" />
                                <ComboBoxItem Content="Carte Bancaire" />
                            </ComboBox>
                        </StackPanel>
                    </Grid>

                    <!--  Recipient  -->
                    <StackPanel Margin="0,0,0,20">
                        <TextBlock
                            Margin="0,0,0,8"
                            FontSize="13"
                            FontWeight="Medium"
                            Text="Bénéficiaire" />
                        <TextBox Style="{StaticResource ModernTextBox}" Text="{Binding Recipient, UpdateSourceTrigger=PropertyChanged}" />
                    </StackPanel>

                    <!--  Case Selection  -->
                    <StackPanel Margin="0,0,0,20">
                        <TextBlock
                            Margin="0,0,0,8"
                            FontSize="13"
                            FontWeight="Medium"
                            Text="Dossier *" />
                        <ComboBox
                            DisplayMemberPath="Number"
                            ItemsSource="{Binding Cases}"
                            SelectedItem="{Binding SelectedCase}"
                            Style="{StaticResource ModernComboBox}" />
                    </StackPanel>

                    <!--  Client Selection  -->
                    <StackPanel Margin="0,0,0,20">
                        <TextBlock
                            Margin="0,0,0,8"
                            FontSize="13"
                            FontWeight="Medium"
                            Text="Ajouté par (Client)" />
                        <ComboBox
                            DisplayMemberPath="FullName"
                            ItemsSource="{Binding Clients}"
                            SelectedItem="{Binding AddedByClient}"
                            Style="{StaticResource ModernComboBox}" />
                    </StackPanel>

                    <!--  Notes  -->
                    <StackPanel Margin="0,0,0,20">
                        <TextBlock
                            Margin="0,0,0,8"
                            FontSize="13"
                            FontWeight="Medium"
                            Text="Notes" />
                        <TextBox
                            MinHeight="80"
                            AcceptsReturn="True"
                            Style="{StaticResource ModernTextBox}"
                            Text="{Binding Notes, UpdateSourceTrigger=PropertyChanged}"
                            TextWrapping="Wrap" />
                    </StackPanel>

                    <!--  Is Paid  -->
                    <CheckBox
                        Content="Dépense payée"
                        IsChecked="{Binding IsPaid}"
                        Style="{StaticResource ModernCheckBox}" />

                    <!--  Validation Error  -->
                    <Border
                        Margin="0,20,0,0"
                        Padding="12"
                        Background="{StaticResource ErrorSubtleBrush}"
                        BorderBrush="{StaticResource ErrorBrush}"
                        BorderThickness="1"
                        CornerRadius="6">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ValidationError, Converter={StaticResource BoolToVis}}" Value="Visible">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock
                            FontSize="13"
                            Foreground="{StaticResource ErrorBrush}"
                            Text="{Binding ValidationError}"
                            TextWrapping="Wrap" />
                    </Border>
                </StackPanel>
            </ScrollViewer>

            <!--  Actions  -->
            <Grid Grid.Row="2" Margin="0,20,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Button
                    Grid.Column="1"
                    Margin="0,0,12,0"
                    Padding="24,12"
                    Command="{Binding CancelCommand}"
                    CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=Window}}"
                    Content="Annuler"
                    Style="{StaticResource OutlineButton}" />

                <Button
                    Grid.Column="2"
                    Padding="24,12"
                    Command="{Binding SaveCommand}"
                    CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=Window}}"
                    Content="Enregistrer"
                    Style="{StaticResource PrimaryButton}" />
            </Grid>
        </Grid>
    </Border>
</Window>